/**
 * Generated By: ap-master-calibration
 *
 * Combined calibration master generation script
 * Processes all bias, dark, and flat groups sequentially
 */

// Redirect console output to log file
Console.beginLog("{{ log_file }}");

console.show();
console.writeln("Starting calibration master generation...");
console.flush();

{% if flat_groups %}
// ===== PHASE 1: Calibrating Flat Frames =====
{% set calibration_needed = namespace(found=false) %}
{% for group in flat_groups %}
{% if group.master_bias_enabled or group.master_dark_enabled %}
{% set calibration_needed.found = true %}
{% endif %}
{% endfor %}
{% if calibration_needed.found %}
console.writeln("\n===== Phase 1: Calibrating Flat Frames =====");
console.flush();
{% for group in flat_groups %}
{% if group.master_bias_enabled or group.master_dark_enabled %}
{% include 'ImageCalibration_flat.j2' %}
{% endif %}
{% endfor %}
{% endif %}
{% endif %}

// ===== PHASE 2: Creating Master Frames =====
console.writeln("\n===== Phase 2: Creating Master Frames =====");
console.flush();

{% if bias_groups %}
console.writeln("Processing Bias Frames...");
console.flush();
{% for group in bias_groups %}
{% include 'ImageIntegration_bias.j2' %}
{% endfor %}
{% endif %}

{% if dark_groups %}
console.writeln("Processing Dark Frames...");
console.flush();
{% for group in dark_groups %}
{% include 'ImageIntegration_dark.j2' %}
{% endfor %}
{% endif %}

{% if flat_groups %}
console.writeln("Processing Flat Frames...");
console.flush();
{% for group in flat_groups %}
{% include 'ImageIntegration_flat.j2' %}
{% endfor %}
{% endif %}

console.writeln("\nAll calibration masters generated successfully!");
console.flush();

// Close log file
Console.endLog();
